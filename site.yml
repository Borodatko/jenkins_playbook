---

- name: Preparing hosts
  hosts: all
  tasks:

  - name: Edit /etc/profile
    become: true
    blockinfile:
      path: /etc/profile
      block: |
        export HISTSIZE=10000
        export HISTTIMEFORMAT="%h %d %H:%M:%S "
        PROMPT_COMMAND='history -a'
        export HISTIGNORE="ls:ll:history:w:htop:pwd"

  - name: Update repository && upgrade packages
    become: true
    ansible.builtin.apt:
      name: "*"
      state: latest
      update_cache: yes

  - name: Install Packages
    become: true
    ansible.builtin.apt:
      pkg:
        - fontconfig
        - openjdk-11-jre
        - gnupg
        - gnupg2
      state: latest

  - name: Rename Hostnames
    become: true
    ansible.builtin.hostname:
      name: "{{ inventory_hostname }}"

  - name: Add user
    become: true
    ansible.builtin.user:
      name: "{{ username }}"
      shell: /bin/bash
      home: /var/lib/jenkins

  - name: Create directory
    become: true
    ansible.builtin.file:
      path: "{{ directory }}"
      state: directory
      mode: '0755'
      owner: "{{ username }}"
      group: "{{ username }}"


- name: Jenkins Installation
  hosts: master
  tasks:

  - name: Install repo key
    become: true
    ansible.builtin.apt_key:
      url: "{{ key_url }}"
      state: present

  - name: Add Jenkins repo
    become: true
    ansible.builtin.apt_repository:
      repo: "{{ repo_string }}"
      state: present 
      filename: jenkins
      update_cache: yes

  - name: Install Jenkins
    become: true
    ansible.builtin.apt:
      pkg:
        - jenkins
        - git
      state: latest

  - name: Genereate SSH Key on Master
    become: true
    ansible.builtin.user:
      name: "{{ username }}"
      generate_ssh_key: yes
      ssh_key_bits: 2048
      ssh_key_file: /var/lib/jenkins/.ssh/id_rsa
    register: ssh_key_info

  - name: Edit known_hosts file
    become: true
    known_hosts:
      name: "{{ hostvars[item].ansible_host }}"
      state: present
      key: "{{ lookup('pipe', 'ssh-keyscan {{ hostvars[item].ansible_host }}') }}"
      hash_host: true
      path: /var/lib/jenkins/.ssh/known_hosts
    with_items: "agent"


- name: Jenkins Agent Configuration
  hosts: agent
  tasks:

  - name: Add master publickey
    become: true
    authorized_key:
      user: "{{ username }}"
      state: present
      key: "{{ hostvars['master']['ssh_key_info']['ssh_public_key'] }}"

  - name: Install Packages
    become: true
    ansible.builtin.apt:
      pkg:
        - docker
        - git
        - python3-pip
      state: latest


- name: Jenkins Configuration
  hosts: master
  tasks:

  - name: Wait 20 seconds
    wait_for:
      timeout=20

  - name: Check file
    become: true
    ansible.builtin.stat:
      path: "/var/lib/jenkins/secrets/initialAdminPassword"
    register: script

  - name: Init admin password
    become: true
    command: 'cat /var/lib/jenkins/secrets/initialAdminPassword'
    changed_when: false
    register: result
    when: script.stat.exists

  - name: Print admin password
    debug:
      var: result.stdout
    when: script.stat.exists
